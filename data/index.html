<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Watering Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #1e1e1e;
      color: #eee;
      padding: 1em;
      max-width: 600px;
      margin: auto;
    }
    .row {
      display: flex;
      gap: 1em;
    }
    .row button {
      flex: 1;
    }
    button {
      width: 100%;
      margin: 0.5em 0;
      padding: 1em;
      font-size: 1.1em;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
    .log, .status {
      margin-top: 2em;
      background-color: #2c2c2c;
      padding: 1em;
      border-radius: 6px;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    #toast {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 1em;
      background-color: #333;
      color: white;
      border-radius: 6px;
      z-index: 1000;
    }
    #versionInfo {
      margin-top: 1.5em;
      font-size: 0.9em;
      color: #aaa;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>Automatic Watering System</h2>

  <button onclick="location.href='/config'">Configuration</button>
  <button onclick="triggerWatering()">Trigger Both Lines</button>

  <div class="row">
    <button onclick="triggerUpper()">Upper Line</button>
    <button onclick="triggerLower()">Lower Line</button>
  </div>

  <button id="skipBtn" onclick="toggleSkip()"></button>
  <button onclick="stopWatering()">Stop Watering</button>

  <div class="row">
    <button id="lightBtn" onclick="toggleLight()">Loading Light...</button>
    <button id="fanBtn" onclick="toggleFan()">Loading Fan...</button>
  </div>

  <div class="status" id="scheduleStatus">Loading schedule...</div>

  <div class="log">
    <h3>Recent Logs</h3>
    <pre id="logContent">Loading logs...</pre>
  </div>

  <div id="versionInfo">Version: loading...</div>
  <div id="toast"></div>

  <script>
    let lightOn = false;
    let fanOn = false;

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 3000);
    }

    function refresh() {
      fetch("/api/status").then(res => res.json()).then(data => {
        document.getElementById("scheduleStatus").innerText =
          `Next schedule: ${data.next}
Skip status: ${data.skip ? "To be skipped" : "Will be watering"}${data.watering ? `
Status: Watering in progress` : ""}`;

        document.getElementById("skipBtn").innerText = data.skip ? "Cancel Skip" : "Skip Next Schedule";

        lightOn = data.light;
        fanOn = data.fan;

        document.getElementById("lightBtn").innerText = lightOn ? "Turn Light OFF" : "Turn Light ON";
        document.getElementById("fanBtn").innerText = fanOn ? "Turn Fan OFF" : "Turn Fan ON";
      });

      fetch("/watering.log")
        .then(r => r.text())
        .then(text => document.getElementById("logContent").innerText = text)
        .catch(() => document.getElementById("logContent").innerText = "Not found: /watering.log");
    }

    function triggerWatering() {
      fetch("/api/trigger", { method: "POST" })
        .then(res => res.json())
        .then(data => showToast(data.status || "Watering started"))
        .catch(() => showToast("Failed to start watering"))
        .finally(refresh);
    }

    function triggerUpper() {
      fetch("/api/trigger/upper", { method: "POST" })
        .then(res => res.json())
        .then(data => showToast(data.status || "Upper line triggered"))
        .catch(() => showToast("Failed to start upper line"))
        .finally(refresh);
    }

    function triggerLower() {
      fetch("/api/trigger/lower", { method: "POST" })
        .then(res => res.json())
        .then(data => showToast(data.status || "Lower line triggered"))
        .catch(() => showToast("Failed to start lower line"))
        .finally(refresh);
    }

    function stopWatering() {
      fetch("/api/stop", { method: "POST" })
        .then(res => res.json())
        .then(data => showToast(data.status || "Watering stopped"))
        .catch(() => showToast("Failed to stop watering"))
        .finally(refresh);
    }

    function toggleSkip() {
      const endpoint = skipBtn.innerText.includes("Cancel") ? "/api/skip/cancel" : "/api/skip";
      fetch(endpoint, { method: "POST" }).then(refresh);
    }

    function toggleLight() {
      fetch("/api/light/" + (lightOn ? "off" : "on"), { method: "POST" })
        .then(res => res.json())
        .then(data => showToast(data.status))
        .finally(refresh);
    }

    function toggleFan() {
      fetch("/api/fan/" + (fanOn ? "off" : "on"), { method: "POST" })
        .then(res => res.json())
        .then(data => showToast(data.status))
        .finally(refresh);
    }

    // Fetch firmware version
    fetch("/api/version")
      .then(res => res.json())
      .then(data => {
        document.getElementById("versionInfo").innerText = "Version: " + data.version;
      });

    setInterval(refresh, 10000);
    refresh();
  </script>
</body>
</html>
